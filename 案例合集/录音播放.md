#audioplayers #path_provider #flutter_sound #permission_handler #provider 
项目地址[permission_handler_test: 各种权限的使用 (gitee.com)](https://gitee.com/fir-sheng/permission_handler_test)
这个案例利用`permission_handler`进行权限管理,用`provider`来进行状态管理,`path_provider`获取存储路径,`flutter_sound`来录音并保存和播放,`audioplayers`负责获取播放时长.
关于介绍,采用一点点添加功能去描述,有利于慢慢了解每个插件的使用
# 实现效果
实现效果为点击`Start Recording`后开始录音.再次点击结束录音,并添加到列表中,显示名称和时长.
点击`Start Playback`后开始播放.再次点击结束播放,或者播放结束自动停止.

![[录音播放实现效果1.1.png]]![[录音播放实现效果1.2.png]]
# 准备工作
项目开始前现根据插件进行准备工作
- permission_handler的配置
- flutter_sound的配置
在![[录音播放案例的准备工作1.1.png]]
下添加
```
    <uses-feature
        android:name="android.hardware.camera"
        android:required="false" />

    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.RECORD_AUDIO"/>
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
```
添加后
![[录音播放的准备工作1.2.png]]
# 第一版录音和播放
首先创建了`RecordingProvider`类去使用`provider` 利于全局的状态管理
```
class RecordingProvider with ChangeNotifier {}
```
录音和播放采用的是`flutter_sound`插件提供的`FlutterSoundRecorder`和`FlutterSoundPlayer`在使用前需要初始化.初始化时要保证具有权限,权限则通过`permission_handler`来获取

```
  Future<void> _initializeRecorder() async {
    try {
      var status = await Permission.microphone.request();
      if (status != PermissionStatus.granted) {
        throw RecordingPermissionException('Microphone permission not granted');
      }
      await _recorder!.openRecorder();
      await _player!.openPlayer();
    } catch (e) {
      print('Failed to initialize recorder/player: $e');
    }
  }
```
==这里有一个权限问题,将在下文解决==
```
class RecordingProvider with ChangeNotifier {
  FlutterSoundRecorder? _recorder; //录音控制器
  FlutterSoundPlayer? _player; //播放控制器
  bool _isRecording = false; //开始录音
  bool _isPlaying = false; //开始播放
  bool get isRecording => _isRecording;
  bool get isPlaying => _isPlaying;

 RecordingProvider() {  
  _recorder = FlutterSoundRecorder();  
  _player = FlutterSoundPlayer();  
  _initializeRecorder();  
 }
}
```
初始化后则需要考虑怎么去使用`_recorder`和`_player` ,继续在`RecordingProvider`中添加新方法,
==开始录音==

`_recorder`录音需要一个存储位置,而这个位置,我们则通过`path_provider`来获取获取临时目录`getTemporaryDirectory()`
```
Future<String> _getFilePath() async {  
  Directory tempDir = await getTemporaryDirectory();  
  String tempPath = '${tempDir.path}/audio_example.aac';  
  return tempPath;  
}
```
继续在`RecordingProvider`中声明变量`String? _filePath`用来存储录音文件的存放位置

```
  String? _filePath; //文件路径
  Future<void> _startRecording() async {
    try {
      var status = await Permission.microphone.request();//获取权限
      if (status != PermissionStatus.granted) {//如果没有权限则不进行录音
        throw RecordingPermissionException('Microphone permission not granted');
      }
      _filePath = await _getFilePath();//获取路径
      await _recorder!.startRecorder(//开始录音
        toFile: _filePath,
        codec: Codec.aacADTS,
      );
    _isRecording = true;//设置标识-正在录音
    notifyListeners();
    } catch (e) {
      print('Failed to start recording: $e');
    }
  }
```
==停止录音==

```
  Future<void> stopRecording() async {
    try {
      await _recorder!.stopRecorder();
      _isRecording = false;
      notifyListeners();
      await getRecordingDuration();
      print('Recording saved to: $_filePath');
    } catch (e) {
      print('Failed to stop recording: $e');
    }
  }
```